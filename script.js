const dbKey='client_notes_v1';let items=load();let filterMode='all';const $=s=>document.querySelector(s);function load(){try{return JSON.parse(localStorage.getItem(dbKey))||[]}catch{return[]}}function save(){localStorage.setItem(dbKey,JSON.stringify(items))}function fmtDate(dt){if(!dt)return'';const d=new Date(dt);if(isNaN(d))return'';return d.toLocaleString()}function todayKey(d=new Date()){return d.toISOString().slice(0,10)}function render(){const q=$('#search').value.trim().toLowerCase();const list=$('#list');list.innerHTML='';const now=new Date();const today=todayKey(now);let shown=0;const tpl=$('#itemTpl').content;items.slice().sort((a,b)=>{const af=a.follow||'9999-12-31T23:59';const bf=b.follow||'9999-12-31T23:59';if(af!==bf)return af.localeCompare(bf);return(b.created||0)-(a.created||0)}).forEach(it=>{const hay=[it.name,it.phone,it.email,it.note,it.tag].join(' ').toLowerCase();if(q&&!hay.includes(q))return;if(filterMode==='today'&&(!it.follow||it.follow.slice(0,10)!==today))return;if(filterMode==='overdue'){if(!it.follow)return;if(new Date(it.follow)>=now)return}if(filterMode==='star'&&!it.star)return;const el=document.importNode(tpl,true);el.querySelector('.tName').textContent=it.name||'(без имени)';const t=[];if(it.phone)t.push('☎ '+it.phone);if(it.email)t.push('✉ '+it.email);if(it.source)t.push('Источник: '+it.source);el.querySelector('.tMeta').textContent=t.join(' · ');el.querySelector('.tNote').textContent=(it.note||'').trim();const tf=el.querySelector('.tFollow');tf.textContent=it.follow?('След. контакт: '+fmtDate(it.follow)):'';const star=el.querySelector('.star');star.textContent=it.star?'★':'☆';star.onclick=()=>{it.star=!it.star;save();render()};const tTag=el.querySelector('.tTag');if(it.tag){tTag.classList.remove('hidden');tTag.textContent=it.tag}const badgeRow=el.querySelector('.tBadgeRow');badgeRow.innerHTML='';if(it.follow){const due=new Date(it.follow);const now=new Date();let label='';if(due.toISOString().slice(0,10)===todayKey(now))label='Сегодня';else if(due<now)label='Просрочено';else label='Заплан.';const b=document.createElement('span');b.className='badge';b.textContent=label;badgeRow.appendChild(b)}el.querySelector('.btnCall').onclick=()=>{if(it.phone)location.href='tel:'+it.phone};el.querySelector('.btnWhats').onclick=()=>{if(!it.phone)return;const p=it.phone.replace(/[^\d]/g,'');const msg=encodeURIComponent((it.name?it.name+', ':'')+(it.note||''));location.href='https://wa.me/'+p+'?text='+msg};el.querySelector('.btnICS').onclick=()=>downloadICS(it);el.querySelector('.btnEdit').onclick=()=>editItem(it);el.querySelector('.btnDel').onclick=()=>{if(confirm('Удалить запись?')){items=items.filter(x=>x.id!==it.id);save();render()}};list.appendChild(el);shown++});$('#stats').textContent='Показано: '+shown+' / '+items.length)}function editItem(it){const name=prompt('Имя',it.name||'');if(name===null)return;const phone=prompt('Телефон',it.phone||'');if(phone===null)return;const email=prompt('Почта',it.email||'');if(email===null)return;const tag=prompt('Тег',it.tag||'');if(tag===null)return;const note=prompt('Заметка',it.note||'');if(note===null)return;const follow=prompt('Следующий контакт (YYYY-MM-DDTHH:MM)',it.follow||'');if(follow===null)return;it.name=name;it.phone=phone;it.email=email;it.tag=tag;it.note=note;it.follow=follow;save();render()}function uuid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}$('#quickForm').addEventListener('submit',e=>{e.preventDefault();const it={id:uuid(),created:Date.now(),name:$('#name').value.trim(),tag:$('#tag').value.trim(),phone:$('#phone').value.trim(),email:$('#email').value.trim(),note:$('#note').value.trim(),follow:$('#follow').value,source:$('#source').value,star:false};items.push(it);save();render();e.target.reset();$('#name').focus()});$('#btnClear').onclick=()=>{$('#quickForm').reset();$('#name').focus()};$('#search').addEventListener('input',render);$('#filterAll').onclick=()=>{filterMode='all';render()};$('#filterToday').onclick=()=>{filterMode='today';render()};$('#filterOverdue').onclick=()=>{filterMode='overdue';render()};$('#filterStar').onclick=()=>{filterMode='star';render()};function exportCSV(){const cols=['id','created','name','tag','phone','email','note','follow','source','star'];const rows=[cols.join(',')];items.forEach(it=>{const line=cols.map(k=>{let v=it[k];if(v===undefined||v===null)v='';v=String(v).replace(/"/g,'""');if(/[",
]/.test(v))v='"'+v+'"';return v}).join(',');rows.push(line)});const blob=new Blob([rows.join('
')],{type:'text/csv;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='clients.csv';a.click()}function importCSV(file){const reader=new FileReader();reader.onload=()=>{const text=reader.result;const lines=text.split(/?
/).filter(Boolean);if(!lines.length)return;const header=lines.shift().split(',');const idx={};header.forEach((h,i)=>idx[h.replace(/(^"|"$)/g,'')]=i);lines.forEach(line=>{const cells=parseCSVLine(line);const it={id:cells[idx.id]||uuid(),created:Number(cells[idx.created]||Date.now()),name:cells[idx.name]||'',tag:cells[idx.tag]||'',phone:cells[idx.phone]||'',email:cells[idx.email]||'',note:cells[idx.note]||'',follow:cells[idx.follow]||'',source:cells[idx.source]||'',star:(cells[idx.star]||'').toLowerCase()==='true'};items.push(it)});save();render()};reader.readAsText(file)}function parseCSVLine(line){const out=[];let cur='';let q=false;for(let i=0;i<line.length;i++){const ch=line[i];if(q){if(ch==='"'&&line[i+1]==='"'){cur+='"';i++}else if(ch==='"'){q=false}else{cur+=ch}}else{if(ch===','){out.push(cur);cur=''}else if(ch==='"'){q=true}else{cur+=ch}}}out.push(cur);return out}document.getElementById('btnExport').onclick=exportCSV;document.getElementById('importFile').addEventListener('change',e=>{const file=e.target.files[0];if(file)importCSV(file)});function downloadICS(it){if(!it.follow){alert('Установи дату/время следующего контакта.');return}const dt=new Date(it.follow);if(isNaN(dt)){alert('Некорректная дата.');return}const dtStart=dt.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';const dtEnd=new Date(dt.getTime()+30*60*1000).toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';const title=`Follow-up: ${it.name||'клиент'}`;const desc=(it.note||'')+(it.phone?` | Тел.: ${it.phone}`:'')+(it.email?` | Почта: ${it.email}`:'');const ics=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//ClientNotes//RU//EN','BEGIN:VEVENT','UID:'+it.id+'@clientnotes','DTSTAMP:'+new Date().toISOString().replace(/[-:]/g,'').split('.')[0]+'Z','DTSTART:'+dtStart,'DTEND:'+dtEnd,'SUMMARY:'+escapeICS(title),'DESCRIPTION:'+escapeICS(desc),'END:VEVENT','END:VCALENDAR'].join('\r\n');const blob=new Blob([ics],{type:'text/calendar;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='followup.ics';a.click()}function escapeICS(s){return String(s).replace(/([,;])/g,'\\$1').replace(/\n/g,'\\n')}render();